<!DOCTYPE html>
<html>
<head>
<title>The Hobbit: Routine at 8B81</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8B78.html">8B78</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8b81">Map</a></td>
<td class="next">
Next: <a href="8C4B.html">8C4B</a>
</td>
</tr>
</table>
<div class="description">8B81: Get Key</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-2"><span id="8b81"></span>8B81</td>
<td class="instruction">DEFB $01,$00,$00,$0D,$02,$00,$00,$02</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b89"></span>8B89</td>
<td class="instruction">DEFW $0000</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b8b"></span>8B8B</td>
<td class="instruction">DEFB $00,$00,$00,$00,$00,$00,$00,$00</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8b93"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="70F3.html">70F3</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GetKey</td>
<td class="address-2"><span id="8b93"></span>8B93</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="3">Stash <span class="register">HL</span>, <span class="register">IX</span> and <span class="register">BC</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b94"></span>8B94</td>
<td class="instruction">PUSH IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b96"></span>8B96</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b97"></span>8B97</td>
<td class="instruction">CALL <a href="8B78.html">Pause</a></td>
<td class="comment-1" rowspan="1">Call <a href="8B78.html">Pause</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b9a"></span>8B9A</td>
<td class="instruction">LD ($8B89),BC</td>
<td class="comment-1" rowspan="1">Write $0000 to <a href="8B81.html#8b89">8B89</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8b9e"></span>8B9E</td>
<td class="instruction">LD HL,$8B8B</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=$8B8B.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8ba1"></span>8BA1</td>
<td class="instruction">LD IX,$8B81</td>
<td class="comment-1" rowspan="1"><span class="register">IX</span>=<a href="8B81.html">8B81</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8ba5"></span>8BA5</td>
<td class="instruction">LD BC,$FEFE</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=$FEFE.</td>
</tr>
<tr>
<td class="asm-label">GetKey_Loop</td>
<td class="address-2"><span id="8ba8"></span>8BA8</td>
<td class="instruction">IN A,(C)</td>
<td class="comment-1" rowspan="1">Read from the keyboard port.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8baa"></span>8BAA</td>
<td class="instruction">AND %00011111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-4.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bac"></span>8BAC</td>
<td class="instruction">OR (IX+$00)</td>
<td class="comment-1" rowspan="1">OR against what <span class="register">IX</span> is pointing to.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8baf"></span>8BAF</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Stash <span class="register">AF</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb0"></span>8BB0</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">Invert the bits (1's complement on <span class="register">A</span>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb1"></span>8BB1</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">Keep bits based on what <span class="register">HL</span> is pointing to.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb2"></span>8BB2</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">Invert the bits back (1's complement on <span class="register">A</span>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb3"></span>8BB3</td>
<td class="instruction">JR Z,<a href="8B81.html#8bbc">GetKey_</a></td>
<td class="comment-1" rowspan="1">If it is zero, jump to <a href="8B81.html#8bbc">GetKey_</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb5"></span>8BB5</td>
<td class="instruction">LD ($8B89),BC</td>
<td class="comment-1" rowspan="1">Stash <span class="register">BC</span> at <a href="8B81.html#8b89">8B89</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bb9"></span>8BB9</td>
<td class="instruction">LD ($8B89),A</td>
<td class="comment-1" rowspan="1">Stash <span class="register">A</span> at <a href="8B81.html#8b89">8B89</a>.</td>
</tr>
<tr>
<td class="asm-label">GetKey_</td>
<td class="address-2"><span id="8bbc"></span>8BBC</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bbd"></span>8BBD</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Stash <span class="register">A</span> at <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bbe"></span>8BBE</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increase <span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bbf"></span>8BBF</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Increase <span class="register">IX</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bc1"></span>8BC1</td>
<td class="instruction">RLC B</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">B</span> left.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bc3"></span>8BC3</td>
<td class="instruction">JR C,<a href="8B81.html#8ba8">GetKey_Loop</a></td>
<td class="comment-1" rowspan="1">If there is carry then this is not a match, jump back to <a href="8B81.html#8ba8">GetKey_Loop</a> to try again.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bc5"></span>8BC5</td>
<td class="instruction">LD BC,($8B89)</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=<a href="8B81.html#8b89">8B89</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8bc9"></span>
<div class="comments">
<div class="paragraph">
If no key match was found, end...
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bc9"></span>8BC9</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="3">If <span class="register">BC</span> is $0000, jump to <a href="8B81.html#8bf6">GetKey_Return</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bca"></span>8BCA</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bcb"></span>8BCB</td>
<td class="instruction">JR Z,<a href="8B81.html#8bf6">GetKey_Return</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bcd"></span>8BCD</td>
<td class="instruction">LD A,$FB</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=$FB.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-2"><span id="8bcf"></span>8BCF</td>
<td class="instruction">ADD A,$05</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<span class="register">A</span> + 5.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bd1"></span>8BD1</td>
<td class="instruction">RRC B</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">B</span> right once.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bd3"></span>8BD3</td>
<td class="instruction">JR C,<a href="8B81.html#8bcf">$8BCF</a></td>
<td class="comment-1" rowspan="1">If there is any carry, jump to <a href="8B81.html#8bcf">8BCF</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bd5"></span>8BD5</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">A</span> by one, ready for the following loop to begin in the same place.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-2"><span id="8bd6"></span>8BD6</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increment <span class="register">A</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bd7"></span>8BD7</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Rotate <span class="register">C</span> right once.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bd9"></span>8BD9</td>
<td class="instruction">JR C,<a href="8B81.html#8bd6">$8BD6</a></td>
<td class="comment-1" rowspan="1">If there is any carry, jump to <a href="8B81.html#8bd6">8BD6</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bdb"></span>8BDB</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="2">Create an offset in <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bdc"></span>8BDC</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bde"></span>8BDE</td>
<td class="instruction">LD HL,$8BFB</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="8B81.html#8bfb">KeyboardMap1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8be1"></span>8BE1</td>
<td class="instruction">LD A,$FE</td>
<td class="comment-1" rowspan="2">Read from the keyboard port. <table class="default">
<tr>
<th colspan="1" rowspan="2">Port Number</th>
<th colspan="5" rowspan="1">Bit</th>
</tr>
<tr>
<th colspan="1" rowspan="1">0</th>
<th colspan="1" rowspan="1">1</th>
<th colspan="1" rowspan="1">2</th>
<th colspan="1" rowspan="1">3</th>
<th colspan="1" rowspan="1">4</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$FE</td>
<td class="centre" colspan="1" rowspan="1">SHIFT</td>
<td class="centre" colspan="1" rowspan="1">Z</td>
<td class="centre" colspan="1" rowspan="1">X</td>
<td class="centre" colspan="1" rowspan="1">C</td>
<td class="centre" colspan="1" rowspan="1">V</td>
</tr>
</table></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8be3"></span>8BE3</td>
<td class="instruction">IN A,($FE)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8be5"></span>8BE5</td>
<td class="instruction">AND %00000001</td>
<td class="comment-1" rowspan="1">Keep only bit 0 (SHIFT).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8be7"></span>8BE7</td>
<td class="instruction">JR Z,<a href="8B81.html#8bf1">GetKey_UseMap2</a></td>
<td class="comment-1" rowspan="1">If it is zero, jump to <a href="8B81.html#8bf1">GetKey_UseMap2</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8be9"></span>8BE9</td>
<td class="instruction">LD A,$7F</td>
<td class="comment-1" rowspan="2">Read from the keyboard port. <table class="default">
<tr>
<th colspan="1" rowspan="2">Port Number</th>
<th colspan="5" rowspan="1">Bit</th>
</tr>
<tr>
<th colspan="1" rowspan="1">0</th>
<th colspan="1" rowspan="1">1</th>
<th colspan="1" rowspan="1">2</th>
<th colspan="1" rowspan="1">3</th>
<th colspan="1" rowspan="1">4</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$7F</td>
<td class="centre" colspan="1" rowspan="1">SPACE</td>
<td class="centre" colspan="1" rowspan="1">FULL-STOP</td>
<td class="centre" colspan="1" rowspan="1">M</td>
<td class="centre" colspan="1" rowspan="1">N</td>
<td class="centre" colspan="1" rowspan="1">B</td>
</tr>
</table></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8beb"></span>8BEB</td>
<td class="instruction">IN A,($FE)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bed"></span>8BED</td>
<td class="instruction">AND %00000010</td>
<td class="comment-1" rowspan="1">Keep only bit 1 (FULL-STOP).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bef"></span>8BEF</td>
<td class="instruction">JR NZ,<a href="8B81.html#8bf4">GetKey_GetByte</a></td>
<td class="comment-1" rowspan="1">If it is not zero, jump to <a href="8B81.html#8bf4">GetKey_GetByte</a>.</td>
</tr>
<tr>
<td class="asm-label">GetKey_UseMap2</td>
<td class="address-2"><span id="8bf1"></span>8BF1</td>
<td class="instruction">LD HL,$8C23</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="8B81.html#8c23">KeyboardMap2</a>.</td>
</tr>
<tr>
<td class="asm-label">GetKey_GetByte</td>
<td class="address-2"><span id="8bf4"></span>8BF4</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<span class="register">HL</span> + keyboard map offset.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bf5"></span>8BF5</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<span class="register">HL</span> (fetched byte from keyboard map).</td>
</tr>
<tr>
<td class="asm-label">GetKey_Return</td>
<td class="address-2"><span id="8bf6"></span>8BF6</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="3">Restore <span class="register">BC</span>, <span class="register">IX</span> and <span class="register">HL</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bf7"></span>8BF7</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bf9"></span>8BF9</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8bfa"></span>8BFA</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="asm-label">KeyboardMap1</td>
<td class="address-1"><span id="8bfb"></span>8BFB</td>
<td class="instruction">DEFB $00,$5A,$58,$43,$56</td>
<td class="comment-1" rowspan="1">--, &#90;, &#88;, &#67;, &#86;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c00"></span>8C00</td>
<td class="instruction">DEFB $41,$53,$44,$46,$47</td>
<td class="comment-1" rowspan="1">&#65;, &#83;, &#68;, &#70;, &#71;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c05"></span>8C05</td>
<td class="instruction">DEFB $51,$57,$45,$52,$54</td>
<td class="comment-1" rowspan="1">&#81;, &#87;, &#69;, &#82;, &#84;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c0a"></span>8C0A</td>
<td class="instruction">DEFB $00,$00,$00,$00,$08</td>
<td class="comment-1" rowspan="1">--, --, --, --, &#8;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c0f"></span>8C0F</td>
<td class="instruction">DEFB $08,$00,$09,$5B,$0A</td>
<td class="comment-1" rowspan="1">&#8;, --, &#9;, &#91;, &#10;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c14"></span>8C14</td>
<td class="instruction">DEFB $50,$4F,$49,$55,$59</td>
<td class="comment-1" rowspan="1">&#80;, &#79;, &#73;, &#85;, &#89;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c19"></span>8C19</td>
<td class="instruction">DEFB $0D,$4C,$4B,$4A,$48</td>
<td class="comment-1" rowspan="1">&#13;, &#76;, &#75;, &#74;, &#72;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c1e"></span>8C1E</td>
<td class="instruction">DEFB $20,$00,$4D,$4E,$42</td>
<td class="comment-1" rowspan="1">&#32;, --, &#77;, &#78;, &#66;</td>
</tr>
<tr>
<td class="asm-label">KeyboardMap2</td>
<td class="address-1"><span id="8c23"></span>8C23</td>
<td class="instruction">DEFB $00,$5A,$58,$43,$56</td>
<td class="comment-1" rowspan="1">--, &#90;, &#88;, &#67;, &#86;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c28"></span>8C28</td>
<td class="instruction">DEFB $41,$53,$44,$46,$47</td>
<td class="comment-1" rowspan="1">&#65;, &#83;, &#68;, &#70;, &#71;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c2d"></span>8C2D</td>
<td class="instruction">DEFB $51,$57,$45,$52,$54</td>
<td class="comment-1" rowspan="1">&#81;, &#87;, &#69;, &#82;, &#84;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c32"></span>8C32</td>
<td class="instruction">DEFB $00,$40,$00,$00,$08</td>
<td class="comment-1" rowspan="1">--, &#64;, --, --, &#8;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c37"></span>8C37</td>
<td class="instruction">DEFB $18,$00,$09,$5B,$0A</td>
<td class="comment-1" rowspan="1">&#24;, --, &#9;, &#91;, &#10;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c3c"></span>8C3C</td>
<td class="instruction">DEFB $22,$4F,$49,$55,$59</td>
<td class="comment-1" rowspan="1">&#34;, &#79;, &#73;, &#85;, &#89;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c41"></span>8C41</td>
<td class="instruction">DEFB $0D,$4C,$4B,$4A,$48</td>
<td class="comment-1" rowspan="1">&#13;, &#76;, &#75;, &#74;, &#72;</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="8c46"></span>8C46</td>
<td class="instruction">DEFB $02,$00,$2E,$2C,$42</td>
<td class="comment-1" rowspan="1">&#2;, --, &#46;, &#44;, &#66;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8B78.html">8B78</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8b81">Map</a></td>
<td class="next">
Next: <a href="8C4B.html">8C4B</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1982 Melbourne House</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.6.</div>
<div><a href="../dec/asm/35713.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>