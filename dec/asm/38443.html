<!DOCTYPE html>
<html>
<head>
<title>The Hobbit: Routine at 38443</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="38381.html">38381</a>
</td>
<td class="up">Up: <a href="../maps/all.html#38443">Map</a></td>
<td class="next">
Next: <a href="38579.html">38579</a>
</td>
</tr>
</table>
<div class="description">38443: "You see ..." Routines</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="36253.html">Action_Dir</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">YouSeeEntry</td>
<td class="address-2"><span id="38443"></span>38443</td>
<td class="instruction">LD HL,45056</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="44413.html#45056">"You see[0x16]"</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38446"></span>38446</td>
<td class="instruction">JR <a href="38443.html#38477">YouSeeWrapper</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="38443.html#38477">YouSeeWrapper</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38448"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="35915.html">Action_Look</a>, <a href="36253.html">Action_Dir</a> and <a href="42305.html">ActionClimbOut</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">YouSeePreposition</td>
<td class="address-2"><span id="38448"></span>38448</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Stash <span class="register">AF</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38449"></span>38449</td>
<td class="instruction">CALL <a href="39857.html">LocateLocation</a></td>
<td class="comment-1" rowspan="1">Call <a href="39857.html">LocateLocation</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38452"></span>38452</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="2">Fetch the location attribute, keep only bits 1-3 which signify the location preposition ("IN", "ON", "AT", etc).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38455"></span>38455</td>
<td class="instruction">AND %00001110</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38457"></span>38457</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">Create an offset for the preposition word look-up.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38458"></span>38458</td>
<td class="instruction">LD D,0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38460"></span>38460</td>
<td class="instruction">LD HL,47744</td>
<td class="comment-1" rowspan="2">Add the offset to <a href="47744.html">47744</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38463"></span>38463</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38464"></span>38464</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Fetch the referenced text bytes which display the preposition word.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38465"></span>38465</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38466"></span>38466</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38467"></span>38467</td>
<td class="instruction">LD HL,45053</td>
<td class="comment-1" rowspan="4">Write the text tokens to <a href="44413.html#45052">$AFFD</a> which updates the copy for "You are XXXX[0x16]".</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38470"></span>38470</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38471"></span>38471</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38472"></span>38472</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38473"></span>38473</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38474"></span>38474</td>
<td class="instruction">LD HL,45052</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="44413.html#45052">"You are in[0x16]"</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38477"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="41958.html">ActionCapture</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">YouSeeWrapper</td>
<td class="address-2"><span id="38477"></span>38477</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="3">Stash <span class="register">IX</span>, <span class="register">IY</span> and <span class="register">BC</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38479"></span>38479</td>
<td class="instruction">PUSH IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38481"></span>38481</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38482"></span>38482</td>
<td class="instruction">CALL <a href="38443.html#38491">YouSeeStart</a></td>
<td class="comment-1" rowspan="1">Call <a href="38443.html#38491">YouSeeStart</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38485"></span>38485</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="3">Restore <span class="register">BC</span>, <span class="register">IY</span> and <span class="register">IX</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38486"></span>38486</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38488"></span>38488</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38490"></span>38490</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38491"></span>
<div class="comments">
<div class="paragraph">
From here starts the "intro" to a location; <ul class="">
<li>Print the "You see[0x16]" text</li>
<li>Handle printing the location data message for this location (if one exists)</li>
<li>Handles initiating the location graphics/ drawing (if it exists)</li>
<li>Handles waiting for a keypress (if something was drawn)</li>
<li>Prints available exits</li>
</ul>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">YouSeeStart</td>
<td class="address-2"><span id="38491"></span>38491</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Store <span class="register">A</span> in <span class="register">B</span> temporarily.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38492"></span>38492</td>
<td class="instruction">CALL <a href="39857.html">LocateLocation</a></td>
<td class="comment-1" rowspan="1">Call <a href="39857.html">LocateLocation</a> to set <span class="register">IX</span> to point to the appropriate <a href="47754.html">location data</a> for the current location.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38495"></span>38495</td>
<td class="instruction">CALL <a href="29405.html">PrintMsg</a></td>
<td class="comment-1" rowspan="1">Call <a href="29405.html">PrintMsg</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38498"></span>38498</td>
<td class="instruction">LD L,(IX+8)</td>
<td class="comment-1" rowspan="2">Load the <a href="47754.html">location data</a> offset for the current location description.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38501"></span>38501</td>
<td class="instruction">LD H,(IX+9)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38504"></span>38504</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Check that there is a value for the description, set zero flag if not.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38505"></span>38505</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38506"></span>38506</td>
<td class="instruction">CALL <a href="38443.html#38534">YouSeePrint</a></td>
<td class="comment-1" rowspan="1">Call <a href="38443.html#38534">YouSeePrint</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38509"></span>38509</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Restore the previous value of <span class="register">A</span> (the location ID).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38510"></span>38510</td>
<td class="instruction">CALL <a href="32632.html">Drawing</a></td>
<td class="comment-1" rowspan="1">Call <a href="32632.html">Drawing</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38513"></span>38513</td>
<td class="instruction">LD A,(32631)</td>
<td class="comment-1" rowspan="3">Test if <a href="32631.html">LocationID</a> contains $FF, call <a href="38443.html#38554">WaitForKey2</a> if it does not (i.e. wait for a keypress only if something has been drawn).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38516"></span>38516</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38517"></span>38517</td>
<td class="instruction">CALL NZ,<a href="38443.html#38554">WaitForKey2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38520"></span>38520</td>
<td class="instruction">CALL <a href="34166.html#34179">34179</a></td>
<td class="comment-1" rowspan="1">Call <a href="34166.html#34179">34179</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38523"></span>38523</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Restore the previous value of <span class="register">A</span> (the location ID).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38524"></span>38524</td>
<td class="instruction">CALL <a href="41160.html">41160</a></td>
<td class="comment-1" rowspan="1">Call <a href="41160.html">41160</a>.</td>
</tr>
<tr>
<td class="asm-label">YouSeeExits</td>
<td class="address-2"><span id="38527"></span>38527</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Restore the previous value of <span class="register">A</span> (the location ID).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38528"></span>38528</td>
<td class="instruction">CALL <a href="41272.html">DisplayExits</a></td>
<td class="comment-1" rowspan="1">Call <a href="41272.html">DisplayExits</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38531"></span>38531</td>
<td class="instruction">JP <a href="40852.html">40852</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="40852.html">40852</a>.</td>
</tr>
<tr>
<td class="asm-label">YouSeePrint</td>
<td class="address-2"><span id="38534"></span>38534</td>
<td class="instruction">JP NZ,<a href="29405.html">PrintMsg</a></td>
<td class="comment-1" rowspan="1">Print the location description if one is present.</td>
</tr>
<tr>
<td class="asm-label">YouSeeNext</td>
<td class="address-2"><span id="38537"></span>38537</td>
<td class="instruction">LD DE,2</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=$0002.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38540"></span>38540</td>
<td class="instruction">PUSH IY</td>
<td class="comment-1" rowspan="1">Stash <span class="register">IY</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38542"></span>38542</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2"><span class="register">IY</span>=<span class="register">IX</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38544"></span>38544</td>
<td class="instruction">POP IY</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38546"></span>38546</td>
<td class="instruction">ADD IY,DE</td>
<td class="comment-1" rowspan="1"><span class="register">IY</span>=<span class="register">IY</span> + $0002 (from <span class="register">DE</span>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38548"></span>38548</td>
<td class="instruction">CALL <a href="40647.html#40662">40662</a></td>
<td class="comment-1" rowspan="1">Call <a href="40647.html#40662">40662</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38551"></span>38551</td>
<td class="instruction">POP IY</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IY</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38553"></span>38553</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38554"></span>
<div class="comments">
<div class="paragraph">
This is almost a carbon copy of <a href="33775.html#33857">WaitForKey</a> only differing in that it ends with a return.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">WaitForKey2</td>
<td class="address-2"><span id="38554"></span>38554</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Read from the keyboard port.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38555"></span>38555</td>
<td class="instruction">IN A,(254)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38557"></span>38557</td>
<td class="instruction">AND %00011111</td>
<td class="comment-1" rowspan="1">A pressed key from any line will set its respective bit; bit 0 (outer key) to bit 4 (inner key). Hence keep only bits 0-4 for the check.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38559"></span>38559</td>
<td class="instruction">CP 31</td>
<td class="comment-1" rowspan="2">Loop back to <a href="38443.html#38554">WaitForKey2</a> until any key has been pressed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38561"></span>38561</td>
<td class="instruction">JR Z,<a href="38443.html#38554">WaitForKey2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38563"></span>38563</td>
<td class="instruction">LD A,7</td>
<td class="comment-1" rowspan="2">Set the border to white.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38565"></span>38565</td>
<td class="instruction">OUT (254),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38567"></span>38567</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38568"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="36253.html">Action_Dir</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">YouSeeController</td>
<td class="address-2"><span id="38568"></span>38568</td>
<td class="instruction">CALL <a href="39857.html">LocateLocation</a></td>
<td class="comment-1" rowspan="1">Call <a href="39857.html">LocateLocation</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38571"></span>38571</td>
<td class="instruction">CALL <a href="38443.html#38537">YouSeeNext</a></td>
<td class="comment-1" rowspan="1">Call <a href="38443.html#38537">YouSeeNext</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38574"></span>38574</td>
<td class="instruction">CALL <a href="34166.html#34179">34179</a></td>
<td class="comment-1" rowspan="1">Call <a href="34166.html#34179">34179</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="38577"></span>38577</td>
<td class="instruction">JR <a href="38443.html#38527">YouSeeExits</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="38443.html#38527">YouSeeExits</a>.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="38381.html">38381</a>
</td>
<td class="up">Up: <a href="../maps/all.html#38443">Map</a></td>
<td class="next">
Next: <a href="38579.html">38579</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1982 Melbourne House</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.6.</div>
<div><a href="../../asm/962B.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>